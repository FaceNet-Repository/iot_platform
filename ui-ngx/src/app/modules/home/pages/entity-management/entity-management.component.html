<!--

    Copyright © 2016-2024 The Thingsboard Authors

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->

<mat-drawer-container hasBackdrop="false" class="tb-absolute-fill">
  <mat-drawer class="tb-details-drawer mat-elevation-z4"
              #drawer
              mode="over"
              position="end"
              [opened]="isDetailsOpen">
    <tb-details-panel
      *ngIf="currentEntity"
      [headerTitle]="currentEntity.name"
      [headerSubtitle]="currentEntity.id.id"
      (closeDetails)="onCloseDetails()"
      [isEdit]="false">
      <div class="details-panel-body">
        <mat-toolbar class="mat-mdc-table-toolbar">
          <div class="mat-toolbar-tools">
            {{ entityConfig.detailConfig.title }}
            <button mat-icon-button
                    matTooltip="Xuất dữ liệu"
                    matTooltipPosition="above"
                    (click)="navigate()">
              <mat-icon>output</mat-icon>
            </button>
          </div>
          <span fxFlex></span>
        </mat-toolbar>
        <div class="information-grid">
          <ng-container *ngFor="let field of entityConfig.detailConfig.fields">
            <span>{{ field.label }}</span>
            <span>{{ currentEntity[field.key] }}</span>
          </ng-container>
        </div>
        <fn-hcp-children-table *ngIf="currentEntity" [entity]="currentEntity"/>
        <div class="button-group">
          <button mat-raised-button>Checklog</button>
          <button mat-raised-button color="primary">Remote control</button>
        </div>
      </div>
    </tb-details-panel>
  </mat-drawer>
  <mat-drawer-content>
    <div class="mat-padding tb-entity-table tb-absolute-fill">
      <div fxLayout="column" class="tb-entity-table-content tb-outlined-border">
        <mat-toolbar class="mat-mdc-table-toolbar" [fxShow]="!textSearchMode">
          <div class="mat-toolbar-tools">
            <div fxLayout="row" fxLayoutAlign="start center" fxLayout.xs="column" fxLayoutAlign.xs="center start"
                 class="title-container">
              <span class="tb-entity-table-title">{{ entityConfig?.title }}</span>
              <div style="display: flex; gap: 0.6rem; justify-content: space-between; align-items: center">
                <span class="tb-entity-table-title badge neutral"
                      matTooltip="Tổng số lượng HCP"
                      matTooltipPosition="above">{{ totalItems }}</span>
                <span class="tb-entity-table-title badge green"
                      matTooltip="Số lượng HCP đang online"
                      matTooltipPosition="above">{{ totalOnline }}</span>
                <span class="tb-entity-table-title badge red"
                      matTooltip="Số lượng HCP đang offline"
                      matTooltipPosition="above">{{ totalOffline }}</span>
                <button mat-icon-button
                        matTooltip="Cập nhật dữ liệu thống kê"
                        matTooltipPosition="above"
                        (click)="updateStatistic()">
                  <mat-icon>sync</mat-icon>
                </button>
              </div>
            </div>
            <span fxFlex></span>
            <div fxShow>
              <button mat-icon-button
                      matTooltip="Cấu hình cột"
                      matTooltipPosition="above"
                      (click)="openTableConfigDialog()">
                <mat-icon>settings</mat-icon>
              </button>
              <button mat-icon-button
                      matTooltip="Xuất dữ liệu"
                      matTooltipPosition="above"
                      (click)="exportData()">
                <mat-icon>file_download</mat-icon>
              </button>
              <button mat-icon-button
                      matTooltip="Tìm kiếm"
                      matTooltipPosition="above"
                      (click)="enterFilterMode()">
                <mat-icon>search</mat-icon>
              </button>
              <ng-template #addActions>
                <button mat-icon-button
                        fxShow
                        matTooltip="Add button here"
                        matTooltipPosition="above">
                  <tb-icon>add</tb-icon>
                </button>
              </ng-template>
            </div>
          </div>
        </mat-toolbar>
        <mat-toolbar class="mat-mdc-table-toolbar" [fxShow]="textSearchMode">
          <div class="mat-toolbar-tools">
            <button mat-icon-button
                    matTooltip="Tìm kiếm"
                    matTooltipPosition="above">
              <mat-icon>search</mat-icon>
            </button>
            <mat-form-field fxFlex>
              <mat-label>&nbsp;</mat-label>
              <input #searchInput matInput
                     [formControl]="textSearch"
                     placeholder="Tìm kiếm HCP"/>
            </mat-form-field>
            <button mat-icon-button (click)="exitFilterMode()"
                    matTooltip="{{ 'action.close' | translate }}"
                    matTooltipPosition="above">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </mat-toolbar>
        <div *ngIf="entityConfig" fxFlex class="table-container">
          <table mat-table [dataSource]="dataSource" matSort matSortDisableClear>
            <ng-container matColumnDef="index" sticky>
              <mat-header-cell *matHeaderCellDef> STT </mat-header-cell>
              <mat-cell *matCellDef="let element; let i = index">
                {{ pageLink.page * pageLink.pageSize + i + 1 }}
              </mat-cell>
            </ng-container >

            <ng-container *ngFor="let column of entityConfig.columns; trackBy: trackByFn">
              <ng-container [matColumnDef]="column.key" [sticky]="column.sticky" [stickyEnd]="column.stickyEnd">
                <mat-header-cell *matHeaderCellDef> {{ column.label }}</mat-header-cell>
                <ng-container [ngSwitch]="column.dataDisplayType">

                  <ng-container *ngSwitchCase="'text'">
                    <mat-cell *matCellDef="let element" style="min-width: 6rem">
                      {{ element[column.key] }}
                    </mat-cell>
                  </ng-container>

                  <ng-container *ngSwitchCase="'datetime'">
                    <mat-cell *matCellDef="let element" style="text-wrap: nowrap">
                      {{ element[column.key] | date: "dd/MM/YYYY hh:mm:ss" }}
                    </mat-cell>
                  </ng-container>

                  <ng-container *ngSwitchCase="'map'" [ngSwitch]="column.key">
                    <ng-container *ngSwitchCase="'active'">
                      <mat-cell *matCellDef="let element" style="text-wrap: nowrap">
                        <span *ngIf="element[column.key] === 'true'" class="badge green">Active</span>
                        <span *ngIf="element[column.key] === 'false'" class="badge red">Inactive</span>
                      </mat-cell>
                    </ng-container>
                    <ng-container *ngSwitchCase="'status'">
                      <mat-cell *matCellDef="let element" style="text-wrap: nowrap">
                        <span *ngIf="element[column.key] === '1'" class="badge green">Online</span>
                        <span *ngIf="element[column.key] === '0'" class="badge red">Offline</span>
                      </mat-cell>
                    </ng-container>
                    <ng-container *ngSwitchDefault>
                      <mat-cell *matCellDef="let element" style="text-wrap: nowrap">
                          <span *ngIf="element[column.key] === 'true'" class="badge green">Active</span>
                          <span *ngIf="element[column.key] === 'false'" class="badge red">Inactive</span>
                      </mat-cell>
                    </ng-container>
                  </ng-container>

                </ng-container>
              </ng-container>
            </ng-container>

            <mat-header-row *matHeaderRowDef="entityConfig.displayedColumns; sticky: true"></mat-header-row>
            <mat-row *matRowDef="let entity; columns: entityConfig.displayedColumns;" (click)="onRowClick($event, entity)"></mat-row>
          </table>
        </div>
        <mat-divider></mat-divider>
        <mat-paginator
          [pageSizeOptions]="pageSizeOptions"
          [pageSize]="pageLink.pageSize"
          [pageIndex]="pageLink.page"
          [length]="totalItems"
          [disabled]="isLoading"
          showFirstLastButtons
          aria-label="Select page">
        </mat-paginator>
      </div>
    </div>
  </mat-drawer-content>
</mat-drawer-container>
